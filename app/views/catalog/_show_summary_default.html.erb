<div class="enhanced-data">
  <% s = enhanced_data(@document) %>
  <% summary = ( (s && s.summary? && s.summary) || @document.marc_summary ) %>
  <% toc = ( (s && s.toc? && s.toc ) || @document.marc_toc ) %>
  <% samplechapter = ( s && s.samplechapter? && s.samplechapter ) || nil %>
  <% unless summary.nil? || summary.empty? %>
    <section class="summary">
      <h4>Summary <span class='show-control more'><a href="javascript:void(0);">(show more)</a></span>
      <span class='show-control less'><a href="javascript:void(0);">(show less)</a></span></h4>
      
      <div class="content">
        <%= summary.html_safe %>
      </div>
     
    </section>
  <% end %>
  <% unless toc.nil? || toc.empty? %>
    <section class="table-of-contents">
  	  <h4>Contents <span class='show-control more'><a href="javascript:void(0);">(show more)</a></span>
      <span class='show-control less'><a href="javascript:void(0);">(show less)</a></span></h4>
      
      <div class="content">
  	   <%= toc.html_safe %>
     </div>
  	</section>
  <% end %>
  <% unless samplechapter.nil? || samplechapter.empty? %>
  <section class="sample-chapter">
    <h4>Sample Chapter <span class='show-control more'><a href="javascript:void(0);">(show more)</a></span>
    <span class='show-control less'><a href="javascript:void(0);">(show less)</a></span></h4>
    
    <div class='content'>
      <%= samplechapter.html_safe %>
    </div>
    
  </section>
  <% end %>
</div>
<script>

  function lineHeight(element) {
    var pxHeight = window.getComputedStyle(element, null).getPropertyValue("line-height");
    return parseInt(pxHeight.replace(/px$/, ''), 10);
  }

  $(document).ready(function() {
    $(".enhanced-data section div.content").each( function() {
      var me = $(this);
      var parent = me.parent();
      var origHeight = me.height();
      var contractedHeight = lineHeight(this) * 3 + 2;
      if ( origHeight <= contractedHeight ) {
        console.log(origHeight, contractedHeight);
        return;
      }

      var contract = function(evt) {
        me.addClass('contracted');
        parent.attr('aria-expanded', 'false');
        me.height(contractedHeight);
      }

      var expand = function(evt) {
        me.removeClass('contracted');
        parent.attr('aria-expanded', 'true');
        me.height(origHeight);
      };

      contract(); // if we got this far, we want to shrink

      parent.find('.more').on('click', expand);
      parent.find('.less').on('click', contract);
    });

   });
  </script>